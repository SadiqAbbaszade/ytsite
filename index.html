<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YT Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0d10;
      --card: #101418;
      --muted: #7a8699;
      --fg: #e9eef5;
      --accent: #7c5cff;
      --accent-2: #3ddc97;
      --danger: #ff5c7a;
      --border: #1b2129;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(124,92,255,.15), transparent), var(--bg);
      color: var(--fg);
    }
    a { color: inherit; text-decoration: none; }

    /* Header */
    .app-header {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: saturate(140%) blur(8px);
      background: rgba(11,13,16,.6);
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      max-width: 1200px; margin: 0 auto; padding: 14px 20px;
      display: flex; align-items: center; gap: 16px; justify-content: space-between;
    }
    .brand { display: flex; gap: 10px; align-items: center; font-weight: 700; letter-spacing: .2px; }
    .brand-badge { width: 32px; height: 32px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #9d7bff); box-shadow: var(--shadow); display: grid; place-items: center; font-size: 14px; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .btn, button {
      display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--border);
      background: linear-gradient(180deg, #141921, #0f141a); color: var(--fg);
      padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600;
      transition: transform .04s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover { border-color: #2a3340; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: linear-gradient(180deg, #7c5cff, #6b4aff); border-color: #6b4aff; }

    /* Container */
    .container { max-width: 1200px; margin: 28px auto 100px; padding: 0 20px; }

    /* Section */
    .section {
      margin-bottom: 34px; position: relative;
    }
    .section h2 { margin: 0 0 12px; font-size: 20px; letter-spacing: .2px; }
    .section .hint { color: var(--muted); font-size: 13px; margin-bottom: 14px; }

    /* Grids */
    .grid { display: grid; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ); gap: 14px; }

    /* Cards */
    .card {
      background: linear-gradient(180deg, #11161d, #0d1217);
      border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 14px; display: grid; grid-template-columns: 56px 1fr auto; gap: 12px; align-items: center;
      position: relative; overflow: visible;
    }
    .card .logo { width: 56px; height: 56px; border-radius: 50%; background: #0b0f14; display: grid; place-items: center; overflow: hidden; border: 1px solid #1d2530; }
    .card .meta { min-width: 0; }
    .card .name { font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card .subs { color: var(--muted); font-size: 13px; margin-top: 3px; }
    .card .go { font-size: 13px; opacity: .9; }

    /* Tooltip */
    .tooltip {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #161c24;
      color: var(--fg);
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      white-space: nowrap;
      font-size: 13px;
      margin-bottom: 6px;
      box-shadow: var(--shadow);
      z-index: 20;
      pointer-events: none;
    }
    .card:hover .tooltip { visibility: visible; opacity: 1; }

    /* Remove button (admin modunda gÃ¶rÃ¼nÃ¼r) */
    .remove-btn {
      position: absolute; top: 8px; right: 8px; padding: 6px 8px; border-radius: 10px;
      background: rgba(255,92,122,.1); border: 1px solid rgba(255,92,122,.35); color: #ff99aa;
      font-weight: 700; display: none; cursor: pointer; font-size: 12px;
    }

    /* Add panels (admin) */
    .add-panel { display: none; margin: 10px 0 16px; gap: 8px; }
    .add-panel input[type="url"], .add-panel input[type="text"] { flex: 1; min-width: 0; background: #0c1116; color: var(--fg); border: 1px solid var(--border); padding: 10px 12px; border-radius: 10px; }
    .add-panel .btn { white-space: nowrap; }

    /* Floating admin toggle (baÅŸta gizli) */
    .admin-toggle { position: fixed; right: 18px; bottom: 18px; display: none; z-index: 60; }

    /* Settings modal (API anahtarÄ± vs.) */
    .modal { position: fixed; inset: 0; display: none; place-items: center; backdrop-filter: blur(8px); background: rgba(0,0,0,.45); z-index: 80; }
    .modal .box { width: 560px; max-width: calc(100% - 24px); background: #0e1319; border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 18px; }
    .modal .box h3 { margin: 0 0 6px; }
    .form-row { display: flex; gap: 8px; margin-top: 10px; }
    .form-row input { flex: 1; background: #0c1116; color: var(--fg); border: 1px solid var(--border); padding: 10px 12px; border-radius: 10px; }

    /* Section placeholders for DM ve bÃ¼yÃ¼me sÄ±ralamasÄ± */
    .placeholder { border: 1px dashed #223; border-radius: var(--radius); padding: 18px; color: var(--muted); text-align: center; }

    /* Admin mod aktifken */
    .admin .remove-btn { display: inline-flex; }
    .admin .add-panel { display: flex; }
    .admin .admin-toggle { display: inline-flex; }

    /* Helper badges */
    .badge { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }

    @media (max-width: 600px) {
      .card { grid-template-columns: 48px 1fr auto; }
      .card .logo { width: 48px; height: 48px; }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-inner">
      <div class="brand">
        <div class="brand-badge">YT</div>
        <div>YT YÃ¶netim Paneli</div>
        <span class="badge" title="Admin modunu aÃ§/kapat: Alt+M">Beta</span>
      </div>
      <div class="header-actions">
        <button id="openSettings" class="btn" title="Ayarlar (API anahtarÄ±)">âš™ï¸ Ayarlar</button>
        <button id="toggleAdmin" class="btn" title="Admin modunu aÃ§/kapat (Alt+M)">ğŸ› ï¸ Admin</button>
      </div>
    </div>
  </header>

  <main class="container" id="app">

    <!-- UYARI: API anahtarÄ± eksikse -->
    <div id="apiWarning" class="section" style="display:none">
      <div class="placeholder">
        <strong>YouTube API anahtarÄ± gerekli.</strong><br>
        CanlÄ± abone sayÄ±sÄ±nÄ± ve kanal bilgisini Ã§ekmek iÃ§in <em>YOUTUBE_API_KEY</em> girin. SaÄŸ Ã¼stten <b>Ayarlar</b>'a tÄ±klayÄ±n.
      </div>
    </div>

    <!-- Benim KanallarÄ±m -->
    <section class="section" id="mine">
      <h2>Benim KanallarÄ±m</h2>
      <div class="hint">Karta tÄ±klayÄ±nca kanal sayfasÄ± aÃ§Ä±lÄ±r. Ekleme/Ã§Ä±karma iÃ§in Admin modunu aÃ§Ä±n.</div>

      <div class="add-panel" id="addMine">
        <input id="mineUrl" type="url" placeholder="Kanal linkini yapÄ±ÅŸtÄ±r (Ã¶r: https://www.youtube.com/@kanal)" />
        <button class="btn btn-primary" id="addMineBtn">Ekle</button>
      </div>

      <div class="grid" id="mineGrid"></div>
    </section>

    <!-- Rakip Kanallar -->
    <section class="section" id="competitors">
      <h2>Rakip Kanallar</h2>
      <div class="hint">AynÄ± kart yapÄ±sÄ±, sadece kategori farklÄ±.</div>

      <div class="add-panel" id="addCompetitor">
        <input id="compUrl" type="url" placeholder="Rakip kanal linkini yapÄ±ÅŸtÄ±r" />
        <button class="btn btn-primary" id="addCompBtn">Ekle</button>
      </div>

      <div class="grid" id="compGrid"></div>
    </section>

    <!-- DM ve bÃ¼yÃ¼me sÄ±ralamasÄ± yer tutucu -->
    <section class="section">
      <h2>DM Kutusu (placeholder)</h2>
      <div class="placeholder">UI resmine gÃ¶re burada DM bileÅŸeni gelecek. Åimdilik iÅŸlevsizlik istenmiÅŸti, sadece yer tutucu bÄ±rakÄ±ldÄ±.</div>
    </section>

    <section class="section">
      <h2>BÃ¼yÃ¼me SÄ±ralamasÄ± (placeholder)</h2>
      <div class="placeholder">Grafikler / tablo vs. daha sonra eklenecek. Åimdilik yer tutucu.</div>
    </section>

  </main>

  <!-- Admin toggle floating (gerekirse) -->
  <button class="btn admin-toggle" id="adminFab">Admin</button>

  <!-- Ayarlar Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="box">
      <h3>ğŸ§© Ayarlar</h3>
      <div style="color:var(--muted); font-size:13px">YouTube canlÄ± abone sayÄ±sÄ± iÃ§in API anahtarÄ± gerekir. Anahtar tarayÄ±cÄ±da <code>localStorage</code>'da tutulur. AÃ§Ä±k kaynak yayÄ±nlarken yeni bir anahtar kullanmanÄ±z Ã¶nerilir.</div>
      <div class="form-row">
        <input id="apiKeyInput" type="text" placeholder="YouTube API Key (v3)" />
        <button class="btn btn-primary" id="saveApiKey">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK ve app init (KULLANICININ VERDÄ°ÄÄ°) -->
  <script type="module">
    // Firebase core
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // KullanÄ±cÄ±nÄ±n verdiÄŸi config
    const firebaseConfig = {
      apiKey: "AIzaSyBy7DShn5TQQMEyPitUZ-9A-o6u0EgD08o",
      authDomain: "yt-sayt.firebaseapp.com",
      projectId: "yt-sayt",
      storageBucket: "yt-sayt.firebasestorage.app",
      messagingSenderId: "614904562607",
      appId: "1:614904562607:web:f352a57fe3f4457077e55a"
    };

    // Firebase baÅŸlat
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM referanslarÄ±
    const mineGrid = document.getElementById('mineGrid');
    const compGrid = document.getElementById('compGrid');
    const addMineBtn = document.getElementById('addMineBtn');
    const addCompBtn = document.getElementById('addCompBtn');
    const mineUrl = document.getElementById('mineUrl');
    const compUrl = document.getElementById('compUrl');

    const settingsModal = document.getElementById('settingsModal');
    const openSettings = document.getElementById('openSettings');
    const saveApiKey = document.getElementById('saveApiKey');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const toggleAdminBtn = document.getElementById('toggleAdmin');
    const adminFab = document.getElementById('adminFab');
    const apiWarning = document.getElementById('apiWarning');

    // LocalStorage anahtar yÃ¶netimi
    const API_KEY_STORAGE = 'YOUTUBE_API_KEY';
    function getApiKey() { return localStorage.getItem(API_KEY_STORAGE) || ''; }
    function setApiKey(v) { localStorage.setItem(API_KEY_STORAGE, v || ''); updateApiWarning(); }

    // Admin modu (baÅŸta kapalÄ±)
    let isAdmin = false;
    function toggleAdmin(force) {
      isAdmin = typeof force === 'boolean' ? force : !isAdmin;
      document.body.classList.toggle('admin', isAdmin);
    }

    // Modal helpers
    function openModal() { settingsModal.style.display = 'grid'; settingsModal.setAttribute('aria-hidden', 'false'); apiKeyInput.value = getApiKey(); apiKeyInput.focus(); }
    function closeModal() { settingsModal.style.display = 'none'; settingsModal.setAttribute('aria-hidden', 'true'); }

    openSettings.addEventListener('click', openModal);
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeModal(); });
    saveApiKey.addEventListener('click', () => { setApiKey(apiKeyInput.value.trim()); closeModal(); });

    // Admin UI
    toggleAdminBtn.addEventListener('click', () => toggleAdmin());
    adminFab.addEventListener('click', () => toggleAdmin());
    window.addEventListener('keydown', (e) => { if (e.altKey && (e.key === 'm' || e.key === 'M')) toggleAdmin(); });

    // UyarÄ±: API anahtarÄ± yoksa bilgi gÃ¶ster
    function updateApiWarning() {
      const hasKey = !!getApiKey();
      apiWarning.style.display = hasKey ? 'none' : 'block';
    }
    updateApiWarning();

    // YardÄ±mcÄ±lar
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function formatSubs(n) {
      n = Number(n || 0);
      if (n >= 1_000_000_000) return (n/1_000_000_000).toFixed(2).replace(/\.00$/, '') + 'B';
      if (n >= 1_000_000) return (n/1_000_000).toFixed(2).replace(/\.00$/, '') + 'M';
      if (n >= 1_000) return (n/1_000).toFixed(1).replace(/\.0$/, '') + 'K';
      return String(n);
    }

    // === HaftalÄ±k istatistik iÃ§in yardÄ±mcÄ±lar ===
    const todayKey = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const weekAgoKey = () => { const d = new Date(); d.setDate(d.getDate() - 7); return d.toISOString().slice(0,10); };

    async function saveSnapshot(channelId, subs, views, cat){
      // aynÄ± gÃ¼n iÃ§in sadece bir kez yaz
      const ref = doc(db, cat, channelId, "stats", todayKey());
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { subs: Number(subs||0), views: Number(views||0), createdAt: serverTimestamp() });
      }
    }

    async function getWeeklyStats(channelId, cat){
      const todayRef = doc(db, cat, channelId, "stats", todayKey());
      const weekRef  = doc(db, cat, channelId, "stats", weekAgoKey());
      const [todaySnap, weekSnap] = await Promise.all([getDoc(todayRef), getDoc(weekRef)]);
      if (todaySnap.exists() && weekSnap.exists()) {
        const a = todaySnap.data(), b = weekSnap.data();
        return {
          subsDelta: (a.subs||0) - (b.subs||0),
          viewsDelta: (a.views||0) - (b.views||0)
        };
      }
      return { subsDelta: 0, viewsDelta: 0 };
    }

    // Kanal linkinden ID/handle Ã§Ã¶z (yalnÄ±zca link alÄ±yoruz)
    function parseChannelFromUrl(url) {
      try {
        const u = new URL(url);
        const mId = u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{22,})/);
        if (mId) return { type: 'id', value: mId[1] };
        const mHandle = u.pathname.match(/\/@([A-Za-z0-9._-]{2,})/);
        if (mHandle) return { type: 'handle', value: '@' + mHandle[1] };
        const mUser = u.pathname.match(/\/c\/([A-Za-z0-9._-]{2,})/);
        if (mUser) return { type: 'username', value: mUser[1] };
        return { type: 'search', value: url };
      } catch (e) {
        if (url.startsWith('@')) return { type: 'handle', value: url };
        return { type: 'search', value: url };
      }
    }

    // YouTube API istekleri
    async function ytFetch(endpoint, params) {
      const apiKey = getApiKey();
      if (!apiKey) throw new Error('API key missing');
      const q = new URLSearchParams({ key: apiKey, ...params });
      const url = `https://www.googleapis.com/youtube/v3/${endpoint}?${q.toString()}`;
      const res = await fetch(url);
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`YouTube API hatasÄ±: ${res.status} ${txt}`);
      }
      return res.json();
    }

    async function resolveChannelId(inputUrl) {
      const p = parseChannelFromUrl(inputUrl);
      if (p.type === 'id') return p.value;
      if (p.type === 'handle') {
        const j = await ytFetch('channels', { part: 'id', forHandle: p.value });
        if (j.items && j.items[0]) return j.items[0].id;
      }
      if (p.type === 'username') {
        const j = await ytFetch('channels', { part: 'id', forUsername: p.value });
        if (j.items && j.items[0]) return j.items[0].id;
      }
      const j = await ytFetch('search', { part: 'snippet', q: p.value, type: 'channel', maxResults: 1 });
      if (j.items && j.items[0]?.snippet?.channelId) return j.items[0].snippet.channelId;
      throw new Error('Kanal bulunamadÄ±. LÃ¼tfen geÃ§erli bir kanal linki verin.');
    }

    async function fetchChannelInfo(channelId) {
      const j = await ytFetch('channels', { part: 'snippet,statistics', id: channelId });
      const it = j.items && j.items[0];
      if (!it) throw new Error('Kanal bilgisi alÄ±namadÄ±.');
      const { title, thumbnails, customUrl } = it.snippet;
      const logo = (thumbnails && (thumbnails.high?.url || thumbnails.default?.url)) || '';
      const subs = Number(it.statistics?.subscriberCount ?? 0);   // gizliyse 0
      const views = Number(it.statistics?.viewCount ?? 0);
      const url   = customUrl ? `https://www.youtube.com/${customUrl}` : `https://www.youtube.com/channel/${channelId}`;
      return { channelId, title, logo, subscribers: subs, views, url };
    }

    // Firestore koleksiyon yollarÄ±
    const colMine = collection(db, 'myChannels');
    const colComp = collection(db, 'competitors');

    // Doc id olarak channelId kullan (idempotent)
    async function addChannel(colRef, inputUrl) {
      const channelId = await resolveChannelId(inputUrl);
      const info = await fetchChannelInfo(channelId);
      await setDoc(doc(colRef, channelId), {
  url: info.url,
  channelId,
  title: info.title,
  logo: info.logo,
  subscribersCache: info.subscribers,
  createdAt: Date.now(),   // âœ… client tarafÄ± timestamp
}, { merge: true });

      // Ekleme sÄ±rasÄ±nda snapshot da kaydet (bugÃ¼nÃ¼n kaydÄ± yoksa)
      const cat = colRef === colMine ? 'myChannels' : 'competitors';
      await saveSnapshot(channelId, info.subscribers, info.views, cat);

      return info;
    }

    async function removeChannel(colRef, channelId) {
      await deleteDoc(doc(colRef, channelId));
    }

    // UI render (tooltip ile)
    function channelCardHTML(data, category, s = { subsDelta: 0, viewsDelta: 0 }) {
  const subsText =
  (data.subscribersLive != null && isFinite(data.subscribersLive))
    ? formatSubs(data.subscribersLive)
    : (data.subscribersCache != null && isFinite(data.subscribersCache))
      ? formatSubs(data.subscribersCache) + ' (cache)'
      : (data.subscribers != null && isFinite(data.subscribers))
        ? formatSubs(data.subscribers) + ' (api)'
        : 'Gizli';

  function sign(v) { return v > 0 ? '+' : (v < 0 ? 'âˆ’' : ''); }

  return `
    <div class="card" data-id="${data.channelId}" data-cat="${category}">
      <div class="logo">
        <img src="${data.logo || ''}" alt="logo" 
             style="width:100%;height:100%;object-fit:cover" 
             onerror="this.style.display='none'"/>
      </div>
      <div class="meta">
        <div class="name" title="${data.title || ''}">${data.title || 'â€”'}</div>
        <div class="subs">Abone: <span>${subsText}</span></div>
      </div>
      <div class="go"><a href="${data.url}" target="_blank" rel="noopener">â†—ï¸ AÃ§</a></div>
      <button class="remove-btn" title="Sil">Sil</button>
      <div class="tooltip">
        <img src="abonelik.png" 
             alt="abone" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;">
        Abone artÄ±ÅŸÄ± (7g): ${sign(s.subsDelta)}${formatSubs(Math.abs(s.subsDelta))}<br>
        
        <img src="izlenme.png" 
             alt="izlenme" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;">
        Ä°zlenme artÄ±ÅŸÄ± (7g): ${sign(s.viewsDelta)}${formatSubs(Math.abs(s.viewsDelta))}
      </div>
    </div>`;
}

    function bindCardEvents(rootEl, colRef) {
      rootEl.querySelectorAll('.card .remove-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const card = e.target.closest('.card');
          const id = card?.dataset.id; if (!id) return;
          if (!confirm('KanalÄ± silmek istediÄŸine emin misin?')) return;
          await removeChannel(colRef, id);
        });
      });
      rootEl.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', (e) => {
          const url = card.querySelector('a')?.href; if (url) window.open(url, '_blank');
        });
      });
    }

    // CanlÄ± veri Ã§ek ve hÄ±zlÄ±ca sadece abone sayÄ±sÄ±nÄ± gÃ¼ncelle (opsiyonel)
    async function refreshLiveStats(container) {
      const ids = Array.from(container.querySelectorAll('.card')).map(c => c.dataset.id).filter(Boolean);
      const apiKey = getApiKey(); if (!apiKey || ids.length === 0) return;
      for (let i = 0; i < ids.length; i += 50) {
        const slice = ids.slice(i, i+50);
        try {
          const j = await ytFetch('channels', { part: 'statistics', id: slice.join(',') });
          const map = new Map((j.items||[]).map(it => [it.id, Number(it.statistics?.subscriberCount ?? NaN)]));
          slice.forEach(id => {
            const card = container.querySelector(`.card[data-id="${id}"]`);
            const subs = map.get(id);
            if (card && isFinite(subs)) {
  const span = card.querySelector('.subs span');
  if (span) span.textContent = formatSubs(subs);

  /for (let i = 0; i < ids.length; i += 50) {
  const slice = ids.slice(i, i+50);
  try {
    const j = await ytFetch('channels', { part: 'statistics', id: slice.join(',') });
    const map = new Map((j.items||[]).map(it => [it.id, Number(it.statistics?.subscriberCount ?? NaN)]));
    slice.forEach(id => {
      const card = container.querySelector(`.card[data-id="${id}"]`);
      const subs = map.get(id);
      if (card && isFinite(subs)) {
        const span = card.querySelector('.subs span');
        if (span) span.textContent = formatSubs(subs);

        // ğŸ”¥ Firestoreâ€™a gÃ¼ncel abone sayÄ±sÄ±nÄ± yaz
        const cat = card.dataset.cat; // 'mine' veya 'comp'
        const colRef = (cat === 'mine') ? colMine : colComp;
        setDoc(doc(colRef, id), {
          subscribersCache: subs,
          subscribersLive: subs,
          updatedAt: serverTimestamp()
        }, { merge: true });
      }   // <-- bu if iÃ§in kapanÄ±ÅŸ
    });   // <-- forEach iÃ§in kapanÄ±ÅŸ
  }       // <-- try iÃ§in KAPANMAMIÅ, burasÄ± eksik!
  catch (err) {
    console.warn('CanlÄ± istatistik Ã§ekilemedi:', err);
  }
  await sleep(350);
}

    // Snapshot dinlemeleri â€” burada canlÄ± info Ã§ek, snapshot yaz, haftalÄ±k delta hesapla ve kartÄ± bas
    import { query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const qMine = query(colMine, orderBy("createdAt", "asc"));
const qComp = query(colComp, orderBy("createdAt", "asc"));

// Snapshot dinlemeleri
onSnapshot(qMine, async (snap) => {
  mineGrid.innerHTML = '';
  const tasks = snap.docs.map(async (docu) => {
    const d = docu.data();
    const info = await fetchChannelInfo(d.channelId);
    await saveSnapshot(info.channelId, info.subscribers, info.views, 'myChannels');
    const stats = await getWeeklyStats(info.channelId, 'myChannels');
    mineGrid.insertAdjacentHTML('beforeend', channelCardHTML({ ...d, ...info }, 'mine', stats));
  });
  await Promise.all(tasks);
  refreshLiveStats(mineGrid);
});

onSnapshot(qComp, async (snap) => {
  compGrid.innerHTML = '';
  const tasks = snap.docs.map(async (docu) => {
    const d = docu.data();
    const info = await fetchChannelInfo(d.channelId);
    await saveSnapshot(info.channelId, info.subscribers, info.views, 'competitors');
    const stats = await getWeeklyStats(info.channelId, 'competitors');
    compGrid.insertAdjacentHTML('beforeend', channelCardHTML({ ...d, ...info }, 'comp', stats));
  });
  await Promise.all(tasks);
  refreshLiveStats(compGrid);
  setInterval(() => {
  refreshLiveStats(mineGrid);
  refreshLiveStats(compGrid);
}, 60_000); // 1 dk
});
    

    // Ekleme butonlarÄ±
    async function handleAdd(colRef, inputEl) {
      const url = inputEl.value.trim(); if (!url) return alert('Link gir');
      try {
        await addChannel(colRef, url); // ekleyince snapshot dinleyicisi zaten tetiklenir
        inputEl.value = '';
      } catch (e) {
        alert(e.message || 'Hata');
      }
    }
    addMineBtn.addEventListener('click', () => handleAdd(colMine, mineUrl));
    addCompBtn.addEventListener('click', () => handleAdd(colComp, compUrl));
    mineUrl.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleAdd(colMine, mineUrl); });
    compUrl.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleAdd(colComp, compUrl); });

    // Ä°lk aÃ§Ä±lÄ±ÅŸ: admin gizli olsun; FAB gÃ¶sterelim (isteÄŸe baÄŸlÄ±)
    document.body.classList.remove('admin');
    adminFab.style.display = 'inline-flex';
  </script>
</body>
</html>
